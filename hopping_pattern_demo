#!/usr/bin/env python

# Copyright 2016 Dominic Spill

from BT_hopping_pattern import piconet

import matplotlib
matplotlib.use('qt5agg')
import matplotlib.pyplot as plt
import matplotlib.animation as animation

MAX_HISTORY = 5
channels = []
colours = [
    #'#0000cc',
    '#ff3300',
    '#0000ff',
    '#0066ff',
    '#3399ff',
    '#66ccff'
]

def animated_barplot(count, rects, pattern):
    if len(channels) == MAX_HISTORY:
        previous_channel = channels.pop()
        rects[previous_channel].set_height(0)
    channels.insert(0, pattern.next())
    for idx, channel in enumerate(channels):
        rects[channel].set_color(colours[idx])
        rects[channel].set_height(1)
    fig.canvas.draw()

if __name__ == '__main__':
	import sys
	if len(sys.argv) < 2:
		print "Using default address of 00:00:65:87:CB:A9"
		address = 0x6587cba9
	else:
		address = int(sys.argv[1].replace(':',''), 16)
	print "Performing hopping pattern pre-calculations"
	pn = piconet.Piconet(address)
	print "Pre-calculations complete"
	fig = plt.figure()
	rects = plt.bar(range(79), [0]*79, width=1, align='center')
	ani = animation.FuncAnimation(fig, animated_barplot, fargs=(rects,pn.gen_hops()))
	plt.show()
